<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashie Dashboard</title>
  <link rel="icon" type="image/png" href="./artwork/Dashie_Logo_Orange_Transparent.png">

  <!-- Core CSS -->
  <link rel="stylesheet" href="./css/core/base.css">
  <link rel="stylesheet" href="./css/core/variables.css">
  <link rel="stylesheet" href="./css/core/themes.css">
  <link rel="stylesheet" href="./css/core/utilities.css">

  <!-- Component CSS -->
  <link rel="stylesheet" href="./css/components/button.css">
  <link rel="stylesheet" href="./css/components/dashie-modal.css">
  <link rel="stylesheet" href="./css/components/theme-overlay.css">
  <link rel="stylesheet" href="./css/components/mobile-landing.css">

  <!-- Module CSS -->
  <link rel="stylesheet" href="./css/modules/login.css">
  <link rel="stylesheet" href="./css/modules/dashboard.css">
  <link rel="stylesheet" href="./css/modules/settings.css">
  <link rel="stylesheet" href="./css/modules/settings-calendar.css">
  <link rel="stylesheet" href="./css/modules/modals.css">
  <link rel="stylesheet" href="./css/modules/welcome.css">

  <!-- Application Bootstrap -->
  <script type="module" src="./js/main.js"></script>
</head>
<body>
  <!-- OAuth Login Screen -->
  <div id="oauth-login-screen">
    <div class="sign-in-modal">
      <img src="./artwork/Dashie_Full_Logo_Orange_Transparent.png" alt="Dashie" class="dashie-logo-signin">

      <!-- Loading Dashboard State (shown when authenticated and loading) -->
      <div class="loading-dashboard-state" id="loading-dashboard-state" style="display: none;">
        <div class="loading-dashboard-welcome" id="loading-dashboard-welcome">Welcome</div>
        <div class="loading-dashboard-spinner" id="loading-dashboard-spinner"></div>
        <div class="loading-dashboard-text" id="loading-dashboard-text">Loading Dashboard</div>
        <div class="loading-dashboard-error" id="loading-dashboard-error" style="display: none;"></div>
        <button class="signin-button secondary" id="loading-cancel-button" style="display: none;">
          Cancel
        </button>
      </div>

      <!-- Sign In State (shown when not authenticated) -->
      <div class="sign-in-state" id="sign-in-state">
        <div class="sign-in-header">
          <h2>Welcome to Dashie!</h2>
          <p id="app-tagline"><!-- Populated by JavaScript --></p>
        </div>

        <div class="sign-in-content">
          <div class="login-status" id="login-status">
            Initializing authentication system...
          </div>

          <button class="signin-button secondary" id="login-button" disabled tabindex="1">
            <span class="spinner"></span>
            <span>Loading...</span>
          </button>

          <button class="signin-button secondary" id="exit-app-btn" tabindex="2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            Exit
          </button>

          <div class="login-error" id="login-error" style="display: none;"></div>

          <p class="privacy-notice">Your data stays private and secure</p>
        </div>

        <div class="sign-in-footer">
          <!-- Site info inside the modal box -->
          <div class="site-info-external" id="site-info-external">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Inline script to detect OAuth callback and stored session -->
      <!-- This runs immediately to prevent flash between sign-in and loading states -->
      <script>
        (function() {
          // Detect if mobile device (simple check)
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                          (window.innerWidth <= 768);

          const urlParams = new URLSearchParams(window.location.search);
          const isOAuthCallback = urlParams.has('code') && urlParams.has('state');

          // Check if returning from hybrid device flow
          const hybridAuthComplete = sessionStorage.getItem('hybrid-auth-complete');

          // Check for stored session (JWT token)
          let hasStoredSession = false;
          try {
            const jwtData = localStorage.getItem('dashie-supabase-jwt');
            if (jwtData) {
              const parsed = JSON.parse(jwtData);
              if (parsed.jwt && parsed.expiry) {
                const now = Date.now();
                hasStoredSession = parsed.expiry > now;
              }
            }
          } catch (error) {
            // No valid session
          }

          // Mobile device with session: hide oauth-login-screen entirely
          if (isMobile && hasStoredSession) {
            const loginScreen = document.getElementById('oauth-login-screen');
            if (loginScreen) {
              loginScreen.style.display = 'none';
            }
          }

          // Desktop/TV: Show loading screen immediately if authenticated
          // 1. OAuth callback detected, OR
          // 2. Hybrid auth complete, OR
          // 3. Valid stored session exists
          if (!isMobile && (isOAuthCallback || hybridAuthComplete || hasStoredSession)) {
            document.getElementById('sign-in-state').style.display = 'none';
            document.getElementById('loading-dashboard-state').style.display = 'flex';

            // Show cancel button immediately
            const cancelButton = document.getElementById('loading-cancel-button');
            if (cancelButton) {
              cancelButton.style.display = 'block';
            }

            // Set welcome message for returning users
            if (hasStoredSession && !isOAuthCallback) {
              try {
                // Try to get actual name from stored user data first
                const userData = localStorage.getItem('dashie-user-data');
                let userName = 'Welcome';

                if (userData) {
                  const user = JSON.parse(userData);
                  if (user.name) {
                    // Use first name from stored user data
                    userName = user.name.split(' ')[0];
                  }
                } else {
                  // Fallback: decode JWT to get name from token payload
                  const jwtData = localStorage.getItem('dashie-supabase-jwt');
                  if (jwtData) {
                    const parsed = JSON.parse(jwtData);
                    if (parsed.jwt) {
                      // Decode JWT payload (middle part)
                      const payload = JSON.parse(atob(parsed.jwt.split('.')[1]));
                      if (payload.user_metadata && payload.user_metadata.full_name) {
                        userName = payload.user_metadata.full_name.split(' ')[0];
                      } else if (payload.name) {
                        userName = payload.name.split(' ')[0];
                      }
                    }
                  }
                }

                const welcomeEl = document.getElementById('loading-dashboard-welcome');
                if (welcomeEl && userName !== 'Welcome') {
                  welcomeEl.textContent = 'Welcome, ' + userName;
                }
              } catch (error) {
                // Keep default welcome message
              }
            }
          }
        })();
      </script>
    </div>
  </div>

  <!-- Mobile Landing Page (shown only on mobile devices) -->
  <div id="mobile-container" class="mobile-mode" style="display: none;">
    <div class="mobile-header">
      <span class="family-name"></span>
      <img class="profile-pic" src="" alt="Profile" style="display: none;">
    </div>

    <div class="mobile-content">
      <img class="dashie-logo" src="./artwork/Dashie_Full_Logo_Orange_Transparent.png" alt="Dashie">

      <!-- Mobile Loading Bar (shown during initialization) -->
      <div id="mobile-loading-bar" class="mobile-loading-bar">
        <div class="mobile-progress-container">
          <div class="mobile-progress-bar">
            <div id="mobile-progress-fill" class="mobile-progress-fill"></div>
          </div>
          <div id="mobile-progress-text" class="mobile-progress-text">Loading...</div>
        </div>
      </div>

      <!-- Settings Button (enabled after initialization) -->
      <button id="mobile-settings-btn" class="orange-button" disabled>Settings</button>

      <!-- Logout Button -->
      <button id="mobile-logout-btn" class="secondary-button" disabled>Logout</button>
    </div>
  </div>

  <!-- Dashboard Container (hidden until authenticated) -->
  <div id="dashboard-container" class="dashboard-container">
    <!-- Dashboard renders here full-screen -->
  </div>

</body>
</html>
